# Taurus-IMU-F411CEU6    
  包含三个文件夹，对应三个程序，如果无法使用，请检查一下：
    STM32F411CEU6的Flash容量512K，起始地址为0x08000000，SIZE：0x00080000（512K），共有8个扇区。
    本程序的分配为：程序区存放在扇区0-6（384K），用户数据存扇区7（128K）。
    本程序使用的动态分配的数组较多，默认堆栈大小不够用，需要在Stm32CubeMX里增大堆栈大小。
    使用FlASH的时候，尽量不用DMA的串口。
    需要根据以上数据设置，如果程序能成功运行，但是下载后覆盖了用户数据，设置Keil下载模式。如果程序能成功运行，但是数据为0，CubeMX增加堆栈大小，检查是否用了DMA的串口。
  # 设置步骤：
      1，Keil - 魔法棒 - Target - IROM1，设置起始地址Start：0x8000000，SIZE：0x60000（384K）
      2，Keil - 魔法棒 - Debug - Settings - FLash Download，设置下载模式为“Erase Sector”，Address Range起始地址Start：0x8000000，SIZE：0x00060000（384K）
      3，Stm32CubeMX - Projet Manage - Project - Linker Settings，设置Heap Size为0x2000，Stack Size为0x1000
      
# 一、校准程序：
  相较F3的校准程序，该版本程序启动后会经历三个阶段，最后再将三轴的补偿量写入FLASH中，用于主程序抑制零漂。
  # 阶段一，温度稳定阶段： 
    此时imu_mode == temperature_error，开启温度稳定。
    两个LED开始闪烁，速度越快代表进度条越接近校准温度。
    此时串口2会以VOFA的FireWater协议输出两个数值：“实时温度”、“设定校准温度”。
    当“实时温度”和“设定校准温度”差值小于0.2°C时，认为达到校准温度，进入下一阶段，再进行校准数值获取。
  # 阶段二，校准阶段：  
    此时imu_mode == normal。
    LED进度条停止闪烁，开始校准，此时不要动板子，稍等片刻校准完成。
    在保持温度同时，读取20000次陀螺仪数据，去掉100个最大最小值，计算平均零漂数值，写入Flah作为补偿数值
  # 阶段三，校准完成：    
    此时imu_mode == finish。
    LED状态为：其中一个常亮，其中一个呼吸灯。
    串口2会以VOFA的FireWater协议输出五个数值：“X轴陀螺仪补偿量”、“Y轴陀螺仪补偿量”、“Z轴陀螺仪补偿量”、“实时温度”、“设定校准温度 

# 二、IMU程序：
  打开校准程序，烧录进去后，自动读取Flash中的补偿量，然后正常运行。以下是一些介绍，以及与F3板子的一些区别。
  # 温度稳定函数： 
    如果温差imu_mode == temperature_error，开启温度稳定。程序设定为31°恒温。
    两个LED开始闪烁，速度越快代表进度条越接近校准温度，达到设定的温度后，LED状态为：其中一个常亮，其中一个呼吸灯。
  # 串口输出：
    初始化结束后，串口2会以VOFA的FireWater协议输出七个数值，“yaw”、“pitch”、“roll”、“Scalar”、“Y”、“X”、“Z”。前三个为陀螺仪欧拉角，输出为三轴角度。后四个为四元数Q0、Q1、Q2、Q3。
    数据使用DMA发送，发送函数为，Uart2_Dma_Printf。调节Print_Fre可以更改打印频次。例：Print_Fre = 15时，每15MS输出一次。其中timestamp每毫秒增加一。
    在While1中循环发送，注释即可取消。
  # 扩展卡尔曼核心函数：
    新的函数为：IMU_QuaternionEKF_Update_Chip，优化了部分代码效率，解决了以前代码Roll相反的问题（四元数中的Q2反了）。
  # 加速度计和陀螺仪初始化修改：
    该版本选择陀螺仪和加速度计的读取频率皆为400HZ。
    因为BMI088陀螺仪采样频率是“2000、1000、400..../hz”，加速度计的采样率是“1600、800、400.../hz”，只有在400HZ的时候陀螺仪和加速度计的采样率才能达成一致。
    查阅资料，两传感器数据同步后，会使得数据融合更加稳定，实测也如此。（实验室环境测试，如果安装在飞镖上实际效果不好后期改回老版本）
    
# 三、VOFA界面：
    菜单 - 文件 - 载入控件串口...，选择.json文件即可导入。如果无法正常显示板子的模型，右键控件 - 模型文件，选择板子PCB.Stl或者飞镖的Stl文件即可。AD无法导出STL，可以导出STEP后转STL。
    包含三个视角的平视欧拉角姿态，一个自由视角欧拉角姿态，一个自由视角四元数姿态。
    
    


    
